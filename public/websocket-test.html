<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO Modern Test Suite</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-hover: #3a56d4;
      --success: #4cc9f0;
      --warning: #f8961e;
      --danger: #f94144;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border-radius: 8px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f6f8ff 0%, #eef1f8 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(90deg, #4361ee 0%, #4cc9f0 100%);
      color: white;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--gray);
      transition: var(--transition);
    }

    .status-text {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .connected .status-indicator {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.3);
    }

    .connecting .status-indicator {
      background: var(--warning);
      box-shadow: 0 0 0 2px rgba(248, 150, 30, 0.3);
    }

    .disconnected .status-indicator {
      background: var(--danger);
      box-shadow: 0 0 0 2px rgba(249, 65, 68, 0.3);
    }

    .connected .status-text {
      color: var(--success);
    }

    .connecting .status-text {
      color: var(--warning);
    }

    .disconnected .status-text {
      color: var(--danger);
    }

    .content {
      padding: 24px;
    }

    .panel {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 16px;
    }

    .panel-header {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray);
    }

    .panel-icon {
      color: var(--primary);
    }

    .row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .input-group {
      display: flex;
      flex: 1;
      min-width: 200px;
      position: relative;
    }

    input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      width: 100%;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    input::placeholder {
      color: #aaa;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: var(--border-radius);
      background: var(--light);
      color: var(--dark);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn:hover {
      background: #e9ecef;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #41b9e2;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e58519;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #e53c3e;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .stat-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--gray);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 600;
    }

    #log {
      background: var(--dark);
      color: #f8f9fa;
      padding: 16px;
      border-radius: var(--border-radius);
      height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    #log div {
      margin-bottom: 4px;
      word-break: break-word;
    }

    #log .info {
      color: #f8f9fa;
    }

    #log .warn {
      color: #ffd166;
    }

    #log .error {
      color: #ef476f;
    }

    .user-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    .user-item:last-child {
      border-bottom: none;
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .user-name {
      font-size: 0.9rem;
    }

    .user-item.current .user-name {
      font-weight: 600;
      color: var(--primary);
    }

    .user-item.current .user-avatar {
      background: var(--primary);
    }

    .tab-container {
      margin-bottom: 16px;
    }

    .tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 12px;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      background: var(--light);
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--gray);
      transition: var(--transition);
    }

    .tab:hover {
      background: #e9ecef;
    }

    .tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 -2px 0 var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Chat Room Styles */
.chat-container {
  display: flex;
  height: 500px;
  background-color: var(--light);
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--shadow);
}

.chat-sidebar {
  width: 250px;
  background-color: white;
  border-right: 1px solid #eee;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background-color: white;
}

.chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background-color: #f8f9fa;
}

.chat-message {
  margin-bottom: 12px;
  padding: 8px 12px;
  border-radius: 8px;
  max-width: 80%;
  animation: fadeIn 0.3s;
}

.chat-message-self {
  background-color: #4361ee;
  color: white;
  align-self: flex-end;
  margin-left: auto;
}

.chat-message-other {
  background-color: white;
  border: 1px solid #eee;
  align-self: flex-start;
}

.chat-message-system {
  background-color: #f8f9fa;
  border: 1px solid #eee;
  color: #6c757d;
  font-style: italic;
  text-align: center;
  max-width: 100%;
  margin: 8px auto;
}

.chat-message-header {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}

.chat-message-name {
  font-weight: 600;
  margin-right: 8px;
}

.chat-message-time {
  font-size: 0.8em;
  color: rgba(255, 255, 255, 0.7);
}

.chat-message-other .chat-message-time {
  color: #6c757d;
}

.chat-message-content {
  word-break: break-word;
}

.chat-input-container {
  display: flex;
  padding: 12px;
  border-top: 1px solid #eee;
}

.chat-input-container input {
  flex: 1;
  margin-right: 8px;
}

.welcome-message {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 20px;
  color: var(--gray);
  text-align: center;
  height: 100%;
}

.welcome-message i {
  font-size: 1.5rem;
  color: var(--primary);
}

.empty-chat-users {
  padding: 15px;
  text-align: center;
  color: var(--gray);
}

/* Responsive design for chat */
@media (max-width: 768px) {
  .chat-container {
    flex-direction: column;
    height: 600px;
  }
  
  .chat-sidebar {
    width: 100%;
    height: 150px;
    border-right: none;
    border-bottom: 1px solid #eee;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-plug"></i> Socket.IO Test Suite</h1>
      <div id="connectionStatus" class="connection-status">
        <div class="status-indicator"></div>
        <span class="status-text">NOT INITIALIZED</span>
      </div>
    </div>

    <div class="content">
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="connection">Connection</div>
          <div class="tab" data-tab="testing">Testing</div>
          <div class="tab" data-tab="rooms">Rooms</div>
          <div class="tab" data-tab="stats">Statistics</div>
<div class="tab" data-tab="chat">Chat Room</div>
        </div>

        <!-- Connection Tab -->
        <div id="connection" class="tab-content active">
          <div class="panel">
            <div class="panel-header">
              <i class="fas fa-network-wired panel-icon"></i>
              <h3 class="panel-title">Connection Controls</h3>
            </div>
            <div class="row">
              <div class="input-group">
                <input id="username" placeholder="Username for auth middleware" />
              </div>
              <button class="btn btn-primary" onclick="connectSocket()">
                <i class="fas fa-plug"></i> Connect
              </button>
              <button class="btn btn-danger" onclick="disconnectSocket()">
                <i class="fas fa-times-circle"></i> Disconnect
              </button>
            </div>
            <div class="row">
              <button class="btn btn-warning" onclick="forceReconnect()">
                <i class="fas fa-sync"></i> Force Reconnect
              </button>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <i class="fas fa-users panel-icon"></i>
              <h3 class="panel-title">Online Users</h3>
            </div>
            <ul id="onlineUsers" class="user-list">
              <!-- Users will be added here dynamically -->
            </ul>
          </div>
        </div>

        <!-- Testing Tab -->
        <div id="testing" class="tab-content">
          <div class="panel">
            <div class="panel-header">
              <i class="fas fa-vial panel-icon"></i>
              <h3 class="panel-title">Test Events</h3>
            </div>
            <div class="row">
              <button class="btn btn-primary" onclick="emitTestEvent()">
                <i class="fas fa-paper-plane"></i> Test Event
              </button>
              <button class="btn btn-primary" onclick="emitAckTest()">
                <i class="fas fa-check-circle"></i> Ack Test
              </button>
              <button class="btn btn-primary" onclick="emitCustomPing()">
                <i class="fas fa-heartbeat"></i> Custom Ping
              </button>
            </div>
            <div class="row">
              <button class="btn btn-danger" onclick="emitErrorEvent()">
                <i class="fas fa-exclamation-triangle"></i> Emit Error
              </button>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <i class="fas fa-broadcast-tower panel-icon"></i>
              <h3 class="panel-title">Broadcast Message</h3>
            </div>
            <div class="row">
              <div class="input-group">
                <input id="broadcastMsg" placeholder="Broadcast message" />
              </div>
              <button class="btn btn-primary" onclick="sendBroadcast()">
                <i class="fas fa-bullhorn"></i> Broadcast
              </button>
            </div>
          </div>
        </div>

        <!-- Rooms Tab -->
        <div id="rooms" class="tab-content">
          <div class="panel">
            <div class="panel-header">
              <i class="fas fa-door-open panel-icon"></i>
              <h3 class="panel-title">Room Management</h3>
            </div>
            <div class="row">
              <div class="input-group">
                <input id="roomName" placeholder="Room name" />
              </div>
              <button class="btn btn-success" onclick="joinRoom()">
                <i class="fas fa-sign-in-alt"></i> Join
              </button>
              <button class="btn btn-danger" onclick="leaveRoom()">
                <i class="fas fa-sign-out-alt"></i> Leave
              </button>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <i class="fas fa-comment-alt panel-icon"></i>
              <h3 class="panel-title">Room Message</h3>
            </div>
            <div class="row">
              <div class="input-group">
                <input id="roomMsg" placeholder="Message to room" />
              </div>
              <button class="btn btn-primary" onclick="sendRoomMessage()">
                <i class="fas fa-paper-plane"></i> Send
              </button>
            </div>
          </div>
        </div>

        <!-- Statistics Tab -->
        <div id="stats" class="tab-content">
          <div class="panel">
            <div class="panel-header">
              <i class="fas fa-chart-line panel-icon"></i>
              <h3 class="panel-title">Connection Statistics</h3>
            </div>
            <div class="stats">
              <div class="stat-card">
                <div class="stat-label">Connection Time</div>
                <div id="connTime" class="stat-value">-</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Uptime</div>
                <div id="uptime" class="stat-value">-</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Last Disconnect</div>
                <div id="lastDisconnect" class="stat-value">-</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Reconnect Count</div>
                <div id="reconnectCount" class="stat-value">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Status</div>
                <div id="wsStatus" class="stat-value">NOT INITIALIZED</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Tab -->
        <div id="chat" class="tab-content">
  <div class="chat-container">
    <div class="chat-sidebar">
      <div class="panel-header">
        <i class="fas fa-users panel-icon"></i>
        <h3 class="panel-title">Online Users</h3>
      </div>
      <ul id="chat-user-list" class="user-list">
        <!-- Users will be added here dynamically -->
        <div class="empty-chat-users">No users online</div>
      </ul>
    </div>
    <div class="chat-main">
      <div class="panel-header">
        <i class="fas fa-comments panel-icon"></i>
        <h3 class="panel-title">Chat Messages</h3>
      </div>
      <div id="chat-messages" class="chat-messages">
        <div class="welcome-message">
          <i class="fas fa-info-circle"></i>
          <p>Welcome to the chat room! Connect to start chatting.</p>
        </div>
      </div>
      <div class="chat-input-container">
        <input id="chat-input" type="text" placeholder="Type a message..." disabled />
        <button id="chat-send-btn" class="btn btn-primary" disabled>
          <i class="fas fa-paper-plane"></i> Send
        </button>
      </div>
    </div>
  </div>
</div>
      </div>
<!-- Add this to your tab navigation in the existing HTML -->
<div class="tab" data-tab="loadtest">Load Testing</div>
<div class="tab" data-tab="latency">Latency Analysis</div>

<!-- Add these tab content sections -->
<div id="loadtest" class="tab-content">
  <div class="panel">
    <div class="panel-header">
      <i class="fas fa-tachometer-alt panel-icon"></i>
      <h3 class="panel-title">Load Test Configuration</h3>
    </div>
    <div class="row">
      <div class="input-group">
        <label for="clientCount">Virtual Clients:</label>
        <input id="clientCount" type="number" min="1" max="500" value="10" />
      </div>
      <div class="input-group">
        <label for="messageFrequency">Message Interval (ms):</label>
        <input id="messageFrequency" type="number" min="100" max="10000" value="1000" />
      </div>
    </div>
    <div class="row">
      <div class="input-group">
        <label for="testDuration">Test Duration (seconds):</label>
        <input id="testDuration" type="number" min="5" max="300" value="30" />
      </div>
      <button class="btn btn-primary" onclick="startLoadTest()">
        <i class="fas fa-play"></i> Start Load Test
      </button>
    </div>
  </div>
  
  <div class="panel">
    <div class="panel-header">
      <i class="fas fa-chart-bar panel-icon"></i>
      <h3 class="panel-title">Load Test Metrics</h3>
    </div>
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Messages Sent</div>
        <div id="messagesSent" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Messages Received</div>
        <div id="messagesReceived" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Message Rate</div>
        <div id="messageRate" class="stat-value">0/s</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Failure Rate</div>
        <div id="failureRate" class="stat-value">0%</div>
      </div>
    </div>
  </div>
</div>

<div id="latency" class="tab-content">
  <div class="panel">
    <div class="panel-header">
      <i class="fas fa-stopwatch panel-icon"></i>
      <h3 class="panel-title">Latency Metrics</h3>
    </div>
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Current Latency</div>
        <div id="currentLatency" class="stat-value">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Latency</div>
        <div id="avgLatency" class="stat-value">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Min Latency</div>
        <div id="minLatency" class="stat-value">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Max Latency</div>
        <div id="maxLatency" class="stat-value">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Connection Quality</div>
        <div id="connectionQuality" class="stat-value">-</div>
      </div>
    </div>
  </div>
  
  <div class="panel">
    <div class="panel-header">
      <i class="fas fa-chart-line panel-icon"></i>
      <h3 class="panel-title">Latency Graph</h3>
    </div>
    <div id="latencyChart" style="width:100%; height:200px; background:#f8f9fa; border-radius:var(--border-radius); display:flex; align-items:center; justify-content:center;">
      <span style="color:var(--gray);">Connect to see latency metrics</span>
    </div>
  </div>
</div>
      <!-- Log Panel (Always visible) -->
      <div class="panel">
        <div class="panel-header">
          <i class="fas fa-terminal panel-icon"></i>
          <h3 class="panel-title">Event Log</h3>
        </div>
        <div id="log"></div>
      </div>
    </div>
  </div>
<!-- Add to the log panel at the bottom of your page -->
<div class="panel-header">
  <i class="fas fa-terminal panel-icon"></i>
  <h3 class="panel-title">Event Log</h3>
  <div style="margin-left: auto; display: flex; gap: 8px;">
    <select id="logTypeFilter" class="filter-select">
      <option value="all">All Types</option>
      <option value="info">Info</option>
      <option value="warn">Warning</option>
      <option value="error">Error</option>
    </select>
    <select id="logCategoryFilter" class="filter-select">
      <option value="all">All Categories</option>
      <option value="connection">Connection</option>
      <option value="event">Events</option>
      <option value="room">Rooms</option>
      <option value="load">Load Test</option>
    </select>
    <input id="logSearch" placeholder="Search logs..." class="filter-input" />
    <button class="btn btn-icon" onclick="clearLogs()">
      <i class="fas fa-trash-alt"></i>
    </button>
    <button class="btn btn-icon" onclick="exportLogs()">
      <i class="fas fa-download"></i>
    </button>
  </div>
</div>
  <script src="/interac/socket.io/socket.io.js"></script>
  <script>
    let socket = null;
    let lastPingTime = null;
    let pingInterval = null;
    let connectTimestamp = null;
    let lastDisconnectTime = null;
    let reconnectCount = 0;
    let uptimeInterval = null;
    
    // Tab Management
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
      });
    });

    function log(msg, type = 'info') {
      const logDiv = document.getElementById('log');
      const el = document.createElement('div');
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      el.classList.add(type);
      logDiv.appendChild(el);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateDashboard() {
      document.getElementById('connTime').textContent = connectTimestamp ? new Date(connectTimestamp).toLocaleTimeString() : '-';
      document.getElementById('lastDisconnect').textContent = lastDisconnectTime ? new Date(lastDisconnectTime).toLocaleTimeString() : '-';
      document.getElementById('reconnectCount').textContent = reconnectCount;
      
      if (connectTimestamp) {
        const diff = Math.floor((Date.now() - connectTimestamp) / 1000);
        const min = Math.floor(diff / 60);
        const sec = diff % 60;
        document.getElementById('uptime').textContent = `${min}m ${sec}s`;
      } else {
        document.getElementById('uptime').textContent = '-';
      }
    }

    function startUptime() {
      if (uptimeInterval) clearInterval(uptimeInterval);
      uptimeInterval = setInterval(updateDashboard, 1000);
    }

    function stopUptime() {
      if (uptimeInterval) clearInterval(uptimeInterval);
      uptimeInterval = null;
    }

    function setStatusIndicator(status) {
      const statusEl = document.getElementById('connectionStatus');
      const statusText = statusEl.querySelector('.status-text');
      
      // Remove all status classes
      statusEl.classList.remove('connected', 'connecting', 'disconnected');
      
      if (status === 'CONNECTED') {
        statusEl.classList.add('connected');
        statusText.textContent = 'CONNECTED';
      } else if (status === 'CONNECTING') {
        statusEl.classList.add('connecting');
        statusText.textContent = 'CONNECTING';
      } else if (status === 'DISCONNECTED') {
        statusEl.classList.add('disconnected');
        statusText.textContent = 'DISCONNECTED';
      } else {
        statusText.textContent = 'NOT INITIALIZED';
      }
      
      // Also update the wsStatus element
      updateWebSocketStatus();
    }

    function updateWebSocketStatus() {
      const wsStatusEl = document.getElementById('wsStatus');
      
      if (socket && socket.connected) {
        wsStatusEl.textContent = 'CONNECTED';
        wsStatusEl.style.color = '#4cc9f0';
      } else if (socket && socket.disconnected) {
        wsStatusEl.textContent = 'DISCONNECTED';
        wsStatusEl.style.color = '#f94144';
      } else {
        wsStatusEl.textContent = 'NOT INITIALIZED';
        wsStatusEl.style.color = '#6c757d';
      }
    }

    function updateOnlineUsers(users) {
      const ul = document.getElementById('onlineUsers');
      ul.innerHTML = '';
      
      if (!Array.isArray(users) || users.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.textContent = 'No users online';
        emptyMessage.style.color = '#6c757d';
        emptyMessage.style.padding = '12px 0';
        emptyMessage.style.textAlign = 'center';
        ul.appendChild(emptyMessage);
        return;
      }
      
      users.forEach(user => {
        const li = document.createElement('li');
        li.className = 'user-item';
        
        // Handle both string usernames and user objects
        // Updated to properly handle the server's user object format
        const username = typeof user === 'string' ? user : (user.username || 'Anonymous');
        const userId = typeof user === 'string' ? user : (user.userId || user.id || 'unknown');
        
        if (username === (window.currentUsername || '')) {
          li.classList.add('current');
        }
        
        // Create avatar with first letter
        const avatar = document.createElement('div');
        avatar.className = 'user-avatar';
        avatar.textContent = (username && username.charAt(0).toUpperCase()) || '?';
        
        const name = document.createElement('div');
        name.className = 'user-name';
        name.textContent = username || 'Anonymous';
        if (username === (window.currentUsername || '')) {
          name.textContent += ' (You)';
        }
        
        li.appendChild(avatar);
        li.appendChild(name);
        ul.appendChild(li);
      });
    }

    async function connectSocket() {
      setStatusIndicator('CONNECTING');
      if (socket && socket.connected) {
        log('Already connected.');
        return;
      }
      window.currentUsername = document.getElementById('username').value.trim() || 'Anonymous';
      const username = window.currentUsername;
      if (!username) {
        log('Please enter a username.', 'error');
        setStatusIndicator('DISCONNECTED');
        return;
      }
      let token = null;
      try {
        const response = await fetch('/interac/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        const data = await response.json();
        if (response.ok && data.token) {
          token = data.token;
          localStorage.setItem('auth_token', token);
          log('Obtained JWT token for user: ' + username);
        } else {
          log('Login failed: ' + (data.error || 'Unknown error'), 'error');
          setStatusIndicator('DISCONNECTED');
          return;
        }
      } catch (err) {
        log('Login request failed: ' + err.message, 'error');
        setStatusIndicator('DISCONNECTED');
        return;
      }
      if (!token) {
        log('No JWT token available. Cannot connect.', 'error');
        setStatusIndicator('DISCONNECTED');
        return;
      }
      socket = io({
        path: '/interac/socket.io',
        auth: { token, username }
      });
      
      // Connection events
      socket.on('connect', () => {
        log('Connected: ' + socket.id);
        connectTimestamp = Date.now();
        updateDashboard();
        startUptime();
        setStatusIndicator('CONNECTED');
        socket.emit('user_join', window.currentUsername);
      });
      
      socket.on('disconnect', reason => {
        log('Disconnected: ' + reason, 'warn');
        lastDisconnectTime = Date.now();
        updateDashboard();
        stopUptime();
        setStatusIndicator('DISCONNECTED');
      });
      
      socket.on('connect_error', err => {
        log('Connect error: ' + err.message, 'error');
        setStatusIndicator('DISCONNECTED');
      });
      
      socket.on('error', err => log('General error: ' + err, 'error'));
      
      // Reconnection events
      socket.on('reconnect_attempt', attempt => {
        log('Reconnect attempt: ' + attempt, 'warn');
        setStatusIndicator('CONNECTING');
      });
      
      socket.on('reconnect', attempt => {
        log('Reconnected after ' + attempt + ' attempt(s)', 'info');
        reconnectCount++;
        updateDashboard();
        setStatusIndicator('CONNECTED');
      });
      
      socket.on('reconnect_error', err => log('Reconnect error: ' + err, 'error'));
      socket.on('reconnect_failed', () => log('Reconnect failed', 'error'));
      
      // Test event
      socket.on('test_response', data => log('Test response: ' + JSON.stringify(data)));
      
      // Ack test
      socket.on('ack_test', data => log('Ack test event received: ' + JSON.stringify(data)));
      
      // Custom ping-pong
      socket.on('custom_pong', data => {
        const rtt = Date.now() - lastPingTime;
        log('Custom pong received. RTT: ' + rtt + ' ms, serverTime: ' + data.serverTime);
      });
      
      // Room events
      socket.on('room_joined', room => log('Joined room: ' + room));
      socket.on('room_left', room => log('Left room: ' + room));
      socket.on('room_announcement', msg => log('Room announcement: ' + msg));
      socket.on('room_message', data => log(`[Room ${data.room}] ${data.user}: ${data.message}`));
      socket.on('rate_limited', data => log('Rate limited on event: ' + data.event, 'warn'));
      
      // Broadcast
      socket.on('broadcast_message', data => log(`[Broadcast] ${data.from}: ${data.message}`));
      
      // User list
      socket.on('user_list', users => {
        updateOnlineUsers(users);
      });
      
      // Engine.IO heartbeat logging
      if (socket && socket.io && socket.io.engine) {
        socket.io.engine.on('ping', () => log('Engine.IO ping sent'));
        socket.io.engine.on('pong', () => log('Engine.IO pong received'));
      }
    }

    function disconnectSocket() {
      if (socket) {
        socket.disconnect();
        log('Socket disconnected by user.');
        setStatusIndicator('DISCONNECTED');
      }
    }

    function emitTestEvent() {
      if (socket && socket.connected) {
        socket.emit('test_event', { time: new Date().toISOString() });
        log('Test event emitted.');
      } else {
        log('Socket not connected. Cannot emit test event.', 'error');
      }
    }

    function emitAckTest() {
      if (socket && socket.connected) {
        socket.emit('ack_test', { time: new Date().toISOString() }, response => {
          log('Ack test callback: ' + JSON.stringify(response));
        });
        log('Ack test emitted.');
      } else {
        log('Socket not connected. Cannot emit ack test.', 'error');
      }
    }

    function emitCustomPing() {
      if (socket && socket.connected) {
        lastPingTime = Date.now();
        socket.emit('custom_ping', { clientTime: new Date().toISOString() });
        log('Custom ping emitted.');
      } else {
        log('Socket not connected. Cannot emit custom ping.', 'error');
      }
    }

    function startPingInterval() {
      stopPingInterval();
      pingInterval = setInterval(() => {
        emitCustomPing();
      }, 5000);
    }

    function stopPingInterval() {
      if (pingInterval) clearInterval(pingInterval);
      pingInterval = null;
    }

    function forceReconnect() {
      if (socket) {
        socket.io.engine.close();
        log('Engine forcibly closed. Should trigger reconnect.');
      } else {
        log('Socket not initialized. Cannot force reconnect.', 'error');
      }
    }

    function emitErrorEvent() {
      if (socket && socket.connected) {
        socket.emit('error', 'Manual error event for test');
        log('Manual error event emitted.');
      } else {
        log('Socket not connected. Cannot emit error event.', 'error');
      }
    }

    function joinRoom() {
      const room = document.getElementById('roomName').value.trim();
      if (socket && socket.connected && room) {
        socket.emit('join_room', room);
        log('Join room emitted: ' + room);
      } else if (!room) {
        log('Please enter a room name.', 'warn');
      } else {
        log('Socket not connected. Cannot join room.', 'error');
      }
    }

    function leaveRoom() {
      const room = document.getElementById('roomName').value.trim();
      if (socket && socket.connected && room) {
        socket.emit('leave_room', room);
        log('Leave room emitted: ' + room);
      } else if (!room) {
        log('Please enter a room name.', 'warn');
      } else {
        log('Socket not connected. Cannot leave room.', 'error');
      }
    }

    function sendRoomMessage() {
      const room = document.getElementById('roomName').value.trim();
      const msg = document.getElementById('roomMsg').value.trim();
      if (socket && socket.connected && room && msg) {
        socket.emit('room_message', { room, message: msg });
        log(`Room message emitted to ${room}: ${msg}`);
        document.getElementById('roomMsg').value = '';
      } else if (!room) {
        log('Please enter a room name.', 'warn');
      } else if (!msg) {
        log('Please enter a message.', 'warn');
      } else {
        log('Socket not connected. Cannot send room message.', 'error');
      }
    }

    function sendBroadcast() {
      const msg = document.getElementById('broadcastMsg').value.trim();
      if (socket && socket.connected && msg) {
        socket.emit('broadcast_message', { message: msg });
        log('Broadcast message emitted: ' + msg);
        document.getElementById('broadcastMsg').value = '';
      } else if (!msg) {
        log('Please enter a message.', 'warn');
      } else {
        log('Socket not connected. Cannot send broadcast message.', 'error');
      }
    }

// Add these chat-specific variables
let chatMessages = [];
const MAX_CHAT_HISTORY = 100;

// Initialize chat UI elements
function initChatUI() {
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  
  // Enable/disable chat inputs based on connection status
  if (socket && socket.connected) {
    chatInput.disabled = false;
    chatSendBtn.disabled = false;
    chatInput.placeholder = "Type a message...";
  } else {
    chatInput.disabled = true;
    chatSendBtn.disabled = true;
    chatInput.placeholder = "Connect to start chatting...";
  }
  
  // Add event listeners for chat input
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChatMessage();
    }
  });
  
  chatSendBtn.addEventListener('click', sendChatMessage);
}

// Send a chat message
function sendChatMessage() {
  const chatInput = document.getElementById('chat-input');
  const message = chatInput.value.trim();
  
  if (message && socket && socket.connected) {
    socket.emit('chat_message', { 
      message,
      timestamp: new Date().toISOString()
    });
    
    // Add to local chat display immediately (optimistic UI)
    addChatMessage({
      from: window.currentUsername,
      message,
      timestamp: new Date().toISOString(),
      isSelf: true
    });
    
    // Clear input
    chatInput.value = '';
    chatInput.focus();
  }
}

// Add a message to the chat display
function addChatMessage(message) {
  const chatMessagesEl = document.getElementById('chat-messages');
  const welcomeMessage = chatMessagesEl.querySelector('.welcome-message');
  
  // Remove welcome message if present
  if (welcomeMessage) {
    welcomeMessage.remove();
  }
  
  // Create message element
  const messageEl = document.createElement('div');
  messageEl.className = 'chat-message';
  
  // Determine message type
  if (message.system) {
    messageEl.classList.add('chat-message-system');
    messageEl.textContent = message.message;
  } else {
    // User message
    messageEl.classList.add(message.isSelf ? 'chat-message-self' : 'chat-message-other');
    
    // Message header with name and time
    const messageHeader = document.createElement('div');
    messageHeader.className = 'chat-message-header';
    
    const messageName = document.createElement('div');
    messageName.className = 'chat-message-name';
    messageName.textContent = message.from || 'Anonymous';
    
    const messageTime = document.createElement('div');
    messageTime.className = 'chat-message-time';
    messageTime.textContent = formatTime(message.timestamp);
    
    messageHeader.appendChild(messageName);
    messageHeader.appendChild(messageTime);
    
    // Message content
    const messageContent = document.createElement('div');
    messageContent.className = 'chat-message-content';
    messageContent.textContent = message.message;
    
    messageEl.appendChild(messageHeader);
    messageEl.appendChild(messageContent);
  }
  
  // Add to DOM
  chatMessagesEl.appendChild(messageEl);
  
  // Scroll to bottom
  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  
  // Store in message history
  chatMessages.push(message);
  if (chatMessages.length > MAX_CHAT_HISTORY) {
    chatMessages.shift();
  }
}

// Format timestamp for chat messages
function formatTime(timestamp) {
  try {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  } catch (e) {
    return '—';
  }
}

// Update the chat user list
function updateChatUserList(users) {
  const userList = document.getElementById('chat-user-list');
  if (!userList) return;
  
  userList.innerHTML = '';
  
  if (!Array.isArray(users) || users.length === 0) {
    const emptyEl = document.createElement('div');
    emptyEl.className = 'empty-chat-users';
    emptyEl.textContent = 'No users online';
    userList.appendChild(emptyEl);
    return;
  }
  
  users.forEach(user => {
    const username = typeof user === 'string' ? user : (user.username || 'Anonymous');
    
    const li = document.createElement('li');
    li.className = 'user-item';
    
    // Highlight current user
    if (username === window.currentUsername) {
      li.classList.add('current');
    }
    
    // Create avatar with first letter
    const avatar = document.createElement('div');
    avatar.className = 'user-avatar';
    avatar.textContent = (username.charAt(0) || '?').toUpperCase();
    
    const name = document.createElement('div');
    name.className = 'user-name';
    name.textContent = username;
    if (username === window.currentUsername) {
      name.textContent += ' (You)';
    }
    
    li.appendChild(avatar);
    li.appendChild(name);
    userList.appendChild(li);
  });
}

// ----- Modify the existing socket.on handlers to add chat support -----

// Modify the connectSocket function to add chat handlers
const originalConnectSocket = connectSocket;
connectSocket = async function() {
  await originalConnectSocket.apply(this, arguments);
  
  if (socket) {
    // Chat message received
    socket.on('chat_message', (data) => {
      log(`Chat message from ${data.from}: ${data.message}`);
      
      // Add to chat display
      addChatMessage({
        from: data.from,
        message: data.message,
        timestamp: data.timestamp || new Date().toISOString(),
        isSelf: data.from === window.currentUsername
      });
    });
    
    // Update chat UI
    initChatUI();
  }
};

// Modify user_list handler to update both user lists
const originalUpdateOnlineUsers = updateOnlineUsers;
updateOnlineUsers = function(users) {
  originalUpdateOnlineUsers.apply(this, arguments);
  
  // Also update the chat user list
  updateChatUserList(users);
};

// Patch socket connect/disconnect events to enable/disable chat
socket?.on('connect', () => {
  initChatUI();
  
  // Add system message
  addChatMessage({
    system: true,
    message: 'You have connected to the chat room.',
    timestamp: new Date().toISOString()
  });
});

socket?.on('disconnect', () => {
  initChatUI();
  
  // Add system message
  addChatMessage({
    system: true,
    message: 'You have been disconnected from the chat room.',
    timestamp: new Date().toISOString()
  });
});

// Initialize chat UI on page load
document.addEventListener('DOMContentLoaded', () => {
  initChatUI();
});
  </script>
</body>
</html>